# ğŸš€ CI/CD Pipeline para DemoMixto
# Automatiza testing, build y deployment en cada push/PR

name: ğŸ”„ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ§ª TESTING Y VALIDACIÃ“N
  test:
    name: ğŸ§ª Tests y Quality Checks
    runs-on: ubuntu-latest
    
    services:
      # ğŸ—„ï¸ MySQL para tests de integraciÃ³n
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: empresa_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      # ğŸƒ MongoDB para tests de integraciÃ³n
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpassword
          MONGO_INITDB_DATABASE: empresa_test
        ports:
          - 27017:27017
        options: --health-cmd="mongosh --eval 'db.runCommand(\"ping\")'" --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
    # â¬‡ï¸ Checkout cÃ³digo
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    # â˜• Setup Java 17
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # ğŸ”§ Cache dependencies
    - name: ğŸ“¦ Cache Maven Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    # âœ… Ejecutar tests unitarios
    - name: ğŸ§ª Run Unit Tests
      run: |
        mvn clean test -Dspring.profiles.active=test
        echo "âœ… Tests unitarios completados"

    # ğŸ” Ejecutar tests de integraciÃ³n
    - name: ğŸ”— Run Integration Tests
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/empresa_test
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: testpassword
        SPRING_DATA_MONGODB_URI: mongodb://testuser:testpassword@localhost:27017/empresa_test?authSource=admin
      run: |
        mvn verify -Dspring.profiles.active=integration-test
        echo "âœ… Tests de integraciÃ³n completados"

    # ğŸ“Š Reporte de cobertura
    - name: ğŸ“Š Generate Test Coverage Report
      run: |
        mvn jacoco:report
        echo "ğŸ“Š Reporte de cobertura generado"

    # ğŸ“¤ Upload coverage to Codecov
    - name: ğŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./target/site/jacoco/jacoco.xml
        flags: unittests
        name: demomixto-coverage

    # ğŸ” SonarQube anÃ¡lisis de cÃ³digo
    - name: ğŸ” SonarQube Code Analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        if [ "$SONAR_TOKEN" != "" ]; then
          mvn sonar:sonar \
            -Dsonar.projectKey=frantastico-rgb_crud-mixto \
            -Dsonar.organization=frantastico-rgb \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN
          echo "ğŸ” AnÃ¡lisis SonarQube completado"
        else
          echo "âš ï¸ SONAR_TOKEN no configurado, saltando anÃ¡lisis"
        fi

  # ğŸ“¦ BUILD Y PACKAGING
  build:
    name: ğŸ“¦ Build Application
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # ğŸ—ï¸ Build application
    - name: ğŸ—ï¸ Build JAR
      run: |
        mvn clean package -DskipTests
        echo "ğŸ“¦ Build completado exitosamente"

    # ğŸ“¤ Upload JAR artifact
    - name: ğŸ“¤ Upload JAR Artifact
      uses: actions/upload-artifact@v3
      with:
        name: demomixto-jar
        path: target/*.jar
        retention-days: 30

  # ğŸ³ DOCKER BUILD
  docker-build:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    # ğŸ³ Setup Docker Buildx
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ğŸ” Login to DockerHub
    - name: ğŸ” Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ğŸ—ï¸ Build and push Docker image
    - name: ğŸ³ Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          frantasticodev/demomixto:latest
          frantasticodev/demomixto:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ğŸš€ DEPLOYMENT (solo en main)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://demomixto.herokuapp.com

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    # ğŸ“¤ Download build artifacts
    - name: ğŸ“¥ Download JAR Artifact
      uses: actions/download-artifact@v3
      with:
        name: demomixto-jar
        path: target/

    # ğŸš€ Deploy to Heroku (ejemplo)
    - name: ğŸš€ Deploy to Heroku
      uses: akhileshns/heroku-deploy@v3.12.14
      with:
        heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
        heroku_app_name: "demomixto-prod"
        heroku_email: "tu-email@ejemplo.com"
        usedocker: true
        docker_build_args: |
          NODE_ENV
          SECRET_KEY

    # ğŸ”” NotificaciÃ³n de deployment exitoso
    - name: ğŸ”” Notify Deployment Success
      if: success()
      run: |
        echo "âœ… Deployment exitoso a producciÃ³n"
        echo "ğŸŒ URL: https://demomixto.herokuapp.com"

    # âš ï¸ NotificaciÃ³n de error
    - name: âš ï¸ Notify Deployment Failure
      if: failure()
      run: |
        echo "âŒ Deployment fallÃ³"
        echo "ğŸ” Revisar logs para mÃ¡s detalles"

  # ï¿½ DEPLOYMENT A RAILWAY (ALTERNATIVO)
  deploy-railway:
    name: ğŸš„ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[railway]')
    
    steps:
    # â¬‡ï¸ Checkout cÃ³digo
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    # ğŸš„ Deploy to Railway using CLI
    - name: ğŸš„ Deploy to Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        # Install Railway CLI
        npm install -g @railway/cli
        
        # Deploy to Railway
        railway deploy --service=${{ secrets.RAILWAY_SERVICE_ID || 'demomixto' }}
    
    # ğŸ”” NotificaciÃ³n Railway success
    - name: ğŸ”” Notify Railway Deployment Success
      if: success()
      run: |
        echo "âœ… Railway deployment exitoso"
        echo "ğŸŒ URL: https://demomixto.up.railway.app"

  # ï¿½ğŸ“Š REPORTES Y NOTIFICACIONES
  notify:
    name: ğŸ“Š Send Notifications
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()

    steps:
    - name: ğŸ“Š Pipeline Status Report
      run: |
        echo "ğŸ“Š REPORTE PIPELINE CI/CD"
        echo "========================"
        echo "ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "ğŸ“¦ Build: ${{ needs.build.result }}"
        echo "ğŸš€ Deploy: ${{ needs.deploy.result }}"
        echo "â° Timestamp: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"